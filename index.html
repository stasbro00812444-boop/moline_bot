<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>MOLINE</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body { font-family: -apple-system, sans-serif; background: #fff; margin: 0; padding: 0; color: #333; }
        .tabs { display: flex; border-bottom: 2px solid #fce4ec; position: sticky; top: 0; background: #fff; z-index: 100; }
        .tab { flex: 1; padding: 15px; text-align: center; font-weight: bold; color: #d1d1d1; text-transform: uppercase; font-size: 14px; }
        .tab.active { color: #f06292; border-bottom: 3px solid #f06292; }
        .container { padding: 15px; padding-bottom: 140px; }
        .cat-title { font-size: 10px; color: #bbb; text-transform: uppercase; margin-top: 15px; letter-spacing: 1px; }
        .card { background: #fff; border: 1.5px solid #fff5f8; border-radius: 15px; padding: 15px; margin-bottom: 12px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 4px 10px rgba(240,98,146,0.05); }
        .card-info { flex: 1; }
        .name { font-weight: 700; font-size: 16px; margin-bottom: 4px; }
        .price { color: #444; font-weight: 500; }
        .controls { display: flex; align-items: center; background: #fff5f8; border-radius: 20px; padding: 4px; border: 1px solid #fce4ec; }
        .btn { background: #f06292; color: #fff; border: none; width: 32px; height: 32px; border-radius: 50%; font-size: 20px; font-weight: bold; cursor: pointer; }
        .q { margin: 0 12px; font-weight: 800; color: #333; min-width: 15px; text-align: center; }
        .footer { position: fixed; bottom: 0; width: 100%; background: #fff; padding: 15px; box-sizing: border-box; border-top: 1px solid #eee; }
        .total-line { display: flex; justify-content: space-between; font-size: 12px; color: #888; margin-bottom: 10px; }
        .order-btn { background: #f06292; color: #fff; border: none; width: 100%; padding: 16px; border-radius: 15px; font-size: 18px; font-weight: bold; }
        .history-card { border-left: 4px solid #f06292; background: #fdf6f8; margin-bottom: 10px; padding: 15px; border-radius: 10px; }
        .hidden { display: none; }
    </style>
</head>
<body>
    <div class="tabs">
        <div class="tab active" id="t-order" onclick="setTab('order')"> –ó–∞–∫–∞–∑</div>
        <div class="tab" id="t-history" onclick="setTab('history')"> –ò—Å—Ç–æ—Ä–∏—è</div>
    </div>

    <div id="p-order" class="container">
        <div id="menu"></div>
    </div>

    <div id="p-history" class="container hidden">
        <div id="history"></div>
    </div>

    <div class="footer" id="footer">
        <div class="total-line">
            <span>–¢–û–í–ê–†–´: <b id="sub">0</b> ‚ÇΩ</span>
            <span>–î–û–°–¢–ê–í–ö–ê: <b id="del">300</b> ‚ÇΩ</span>
        </div>
        <div style="font-size: 22px; font-weight: 900; margin-bottom: 10px;">–ò–¢–û–ì–û: <span id="total">300</span> ‚ÇΩ</div>
        <button class="order-btn" onclick="submitOrder()">–û–§–û–†–ú–ò–¢–¨ ‚ú®</button>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        const API = "https://script.google.com/macros/s/AKfycbzx9V8HKo7LeQlfoYSA4f-e89IxfUMU7p4PQ58htm5dejZifmQc3brNfW0Y9Pupsm6t/exec";
        const user = tg.initDataUnsafe?.user?.username || "guest";
        let cart = {}, menuData = [];

        async function load() {
            const m = await fetch(`${API}?type=menu`).then(r => r.json());
            menuData = m.menu;
            renderMenu();
            const h = await fetch(`${API}?type=history&user=${user}`).then(r => r.json());
            renderHistory(h);
        }

        function renderMenu() {
            let html = "", lastCat = "";
            menuData.forEach(i => {
                if(i.cat !== lastCat) html += `<div class="cat-title">${i.cat}</div>`;
                html += `<div class="card"><div class="card-info"><div class="name">${i.name}</div><div class="price">${i.price} ‚ÇΩ</div></div>
                <div class="controls"><button class="btn" onclick="upd('${i.name}',-1,${i.price})">-</button><div class="q" id="q-${i.name}">0</div>
                <button class="btn" onclick="upd('${i.name}',1,${i.price})">+</button></div></div>`;
                lastCat = i.cat;
            });
            document.getElementById('menu').innerHTML = html;
        }

        function upd(name, d, p) {
            if(!cart[name]) cart[name] = {qty:0, price:p};
            cart[name].qty = Math.max(0, cart[name].qty + d);
            if(cart[name].qty === 0) delete cart[name];
            document.getElementById(`q-${name}`).innerText = cart[name]?.qty || 0;
            calc();
        }

        function calc() {
            let s = 0; Object.values(cart).forEach(i => s += i.qty * i.price);
            let d = (s > 0 && s < 3000) ? 300 : 0;
            document.getElementById('sub').innerText = s;
            document.getElementById('del').innerText = d;
            document.getElementById('total').innerText = s + d;
        }

        function setTab(t) {
            document.getElementById('p-order').classList.toggle('hidden', t!=='order');
            document.getElementById('p-history').classList.toggle('hidden', t!=='history');
            document.getElementById('footer').classList.toggle('hidden', t!=='order');
            document.getElementById('t-order').classList.toggle('active', t==='order');
            document.getElementById('t-history').classList.toggle('active', t==='history');
        }

        function renderHistory(h) {
            let html = "";
            Object.keys(h).sort().reverse().forEach(d => {
                html += `<div class="history-card"><b>üìÖ ${d}</b><br>${h[d].items.map(i=>`‚Ä¢ ${i.name} x${i.qty}`).join('<br>')}
                <br><b>–ò—Ç–æ–≥–æ: ${h[d].total} ‚ÇΩ</b><br><button onclick="repeat('${d}', ${JSON.stringify(h[d].items).replace(/"/g, '&quot;')})" 
                style="margin-top:10px; background:#eee; border:none; padding:5px 10px; border-radius:5px;">–ü–æ–≤—Ç–æ—Ä–∏—Ç—å üîÑ</button></div>`;
            });
            document.getElementById('history').innerHTML = html || "–ò—Å—Ç–æ—Ä–∏—è –ø—É—Å—Ç–∞ üêå";
        }

        function repeat(d, items) {
            cart = {};
            items.forEach(i => { cart[i.name] = {qty: i.qty, price: i.price}; });
            setTab('order'); renderMenu();
            Object.keys(cart).forEach(name => { document.getElementById(`q-${name}`).innerText = cart[name].qty; });
            calc();
        }

        async function submitOrder() {
            if(Object.keys(cart).length === 0) return alert("–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞ ü•ê");
            const date = prompt("–î–∞—Ç–∞ (–ì–ì–ì–ì-–ú–ú-–î–î):", new Date(Date.now() + 86400000).toISOString().split('T')[0]);
            if(!date) return;
            await fetch(API, {method:'POST', body:JSON.stringify({user, date, items:cart})});
            tg.close();
        }
        load();
    </script>
</body>
</html>
