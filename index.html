<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body { font-family: -apple-system, sans-serif; background: #f4f6f9; margin: 0; padding: 0; }
        .tabs { display: flex; background: #fff; border-bottom: 1px solid #ddd; position: sticky; top: 0; z-index: 100; }
        .tab { flex: 1; text-align: center; padding: 15px; font-weight: bold; color: #999; cursor: pointer; }
        .tab.active { color: #0088cc; border-bottom: 3px solid #0088cc; }
        .container { padding: 15px; padding-bottom: 100px; }
        .card { background: #fff; border-radius: 12px; padding: 15px; margin-bottom: 10px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .product-row { display: flex; align-items: center; justify-content: space-between; }
        .stepper { display: flex; align-items: center; background: #f1f3f4; border-radius: 20px; padding: 4px; }
        .btn { width: 32px; height: 32px; border: none; background: none; color: #0088cc; font-size: 24px; cursor: pointer; line-height: 1; }
        .footer { position: fixed; bottom: 0; width: 100%; background: #fff; border-top: 1px solid #ddd; padding: 15px; display: flex; justify-content: space-between; align-items: center; box-sizing: border-box; }
        .send-btn { background: #0088cc; color: #fff; border: none; padding: 12px 25px; border-radius: 12px; font-weight: bold; }
        .hidden { display: none; }
        .error-msg { color: red; text-align: center; padding: 20px; font-size: 14px; }
    </style>
</head>
<body>

<div class="tabs">
    <div id="t-order" class="tab active" onclick="show('order')">ЗАКАЗАТЬ</div>
    <div id="t-hist" class="tab" onclick="show('history')">ИСТОРИЯ</div>
</div>

<div id="page-order" class="container">
    <div class="card">
        <label style="font-size:12px; color:#888;">ДАТА ДОСТАВКИ</label>
        <input type="date" id="date" style="width:100%; margin-top:8px; padding:10px; border-radius:8px; border:1px solid #ddd; font-size:16px;">
    </div>
    <div id="menu"></div>
</div>

<div id="page-hist" class="container hidden"></div>

<div class="footer" id="foot">
    <div><small style="color:#888">Итого:</small><br><b id="total" style="font-size:20px">0 ₽</b></div>
    <button class="send-btn" onclick="send()">ОФОРМИТЬ</button>
</div>

<script>
    const tg = window.Telegram.WebApp;
    // ЗАМЕНИ ССЫЛКУ НИЖЕ
    const API = 'ТВОЯ_ССЫЛКА_EXEC'; 
    const user = tg.initDataUnsafe.user?.username || tg.initDataUnsafe.user?.first_name || "Guest";
    let cart = {};

    const inp = document.getElementById('date');
    const tom = new Date(); tom.setDate(tom.getDate() + 1);
    inp.value = tom.toISOString().split('T')[0];
    inp.min = inp.value;

    async function loadMenu() {
        const m = document.getElementById('menu');
        m.innerHTML = '<p style="text-align:center;color:#999;padding:20px;">Загрузка прайса...</p>';
        try {
            const r = await fetch(`${API}?type=menu&user=${user}`);
            const items = await r.json();
            if (items.error) {
                m.innerHTML = `<div class="error-msg">Ошибка: ${items.error}</div>`;
                return;
            }
            m.innerHTML = '';
            items.forEach(p => {
                const d = document.createElement('div');
                d.className = 'card product-row';
                d.innerHTML = `<div><b>${p.name}</b><br><span style="color:#0088cc">${p.price} ₽</span></div>
                    <div class="stepper"><button class="btn" onclick="upd('${p.name}', ${p.price}, -1, this)">−</button>
                    <div class="val" style="min-width:30px;text-align:center;font-weight:bold">0</div>
                    <button class="btn" onclick="upd('${p.name}', ${p.price}, 1, this)">+</button></div>`;
                m.appendChild(d);
            });
        } catch(e) {
            m.innerHTML = '<div class="error-msg">Сервер недоступен. Проверьте развертывание в Google Scripts.</div>';
        }
    }

    function upd(n, p, delta, el) {
        const v = el.parentElement.querySelector('.val');
        let q = (cart[n]?.qty || 0) + delta;
        if (q < 0) q = 0; v.innerText = q;
        if (q > 0) cart[n] = { qty: q, price: p }; else delete cart[n];
        let s = 0; for (let k in cart) s += cart[k].qty * cart[k].price;
        document.getElementById('total').innerText = s + " ₽";
    }

    function show(p) {
        document.getElementById('t-order').className = p=='order'?'tab active':'tab';
        document.getElementById('t-hist').className = p=='history'?'tab active':'tab';
        document.getElementById('page-order').classList.toggle('hidden', p!='order');
        document.getElementById('page-hist').classList.toggle('hidden', p!='history');
        document.getElementById('foot').classList.toggle('hidden', p!='order');
        if (p=='history') loadHist();
    }

    async function loadHist() {
        const d = document.getElementById('page-hist');
        d.innerHTML = '<p style="text-align:center;color:#999;padding:20px;">Синхронизация...</p>';
        try {
            const r = await fetch(`${API}?user=${user}`);
            const data = await r.json();
            let h = '<h3>Ваша история заказов</h3>';
            for (let date in data) {
                h += `<div class="card"><div style="display:flex;justify-content:space-between;border-bottom:1px solid #eee;padding-bottom:10px;margin-bottom:10px">
                    <b>${date}</b><b style="color:#0088cc">${data[date].total} ₽</b></div>`;
                data[date].items.forEach(i => { h += `<div style="display:flex;justify-content:space-between;font-size:14px"><span>${i.name}</span><b>x${i.qty}</b></div>`; });
                h += `</div>`;
            }
            d.innerHTML = Object.keys(data).length > 0 ? h : '<p style="text-align:center;margin-top:50px;color:#999">История пуста</p>';
        } catch(e) { d.innerHTML = '<div class="error-msg">Ошибка загрузки истории</div>'; }
    }

    async function send() {
        if (!Object.keys(cart).length) return tg.showAlert("Выберите товары!");
        tg.showConfirm("Подтвердить заказ?", async (ok) => {
            if (ok) {
                await fetch(API, { method: 'POST', mode: 'no-cors', body: JSON.stringify({ user, date: inp.value, items: cart }) });
                tg.showAlert("✅ Заказ успешно оформлен!");
                tg.close();
            }
        });
    }

    loadMenu();
    tg.expand();
</script>
</body>
</html>
