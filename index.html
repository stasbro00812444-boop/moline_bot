<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body { font-family: sans-serif; background: #f4f6f9; padding: 15px; }
        .card { background: #fff; border-radius: 10px; padding: 15px; margin-bottom: 10px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .error { color: #d9534f; background: #f8d7da; padding: 10px; border-radius: 8px; font-size: 14px; line-height: 1.4; }
        .row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .btn { background: #0088cc; color: #fff; border: none; padding: 10px 20px; border-radius: 8px; font-weight: bold; width: 100%; }
        .hidden { display: none; }
    </style>
</head>
<body>
    <div id="p1">
        <div class="card"><input type="date" id="dt" style="width:100%; font-size:16px;"></div>
        <div id="menu"></div>
    </div>
    <div id="f" style="margin-top:20px;"><button class="btn" onclick="send()">ОФОРМИТЬ</button></div>

<script>
    const tg = window.Telegram.WebApp;
    const API = 'ССЫЛКА_ИЗ_ГАЗ'; // Замените на вашу
    const user = String(tg.initDataUnsafe.user?.username || tg.initDataUnsafe.user?.id || "Guest").replace('@','').toLowerCase().trim();

    async function load() {
        const dt = document.getElementById('dt');
        let min = new Date(); min.setDate(min.getDate() + 1);
        dt.value = min.toISOString().split('T')[0];

        const box = document.getElementById('menu');
        box.innerHTML = 'Загрузка...';

        try {
            const resp = await fetch(`${API}?type=menu&user=${user}&v=${Date.now()}`);
            const data = await resp.json();

            if (data.error) {
                box.innerHTML = `<div class="error"><b>Ошибка:</b><br>${data.error}</div>`;
                return;
            }

            if (data.menu.length === 0) {
                box.innerHTML = '<div class="error">В листе с меню нет товаров (пустые строки).</div>';
                return;
            }

            box.innerHTML = '';
            data.menu.forEach(item => {
                const div = document.createElement('div');
                div.className = 'card row';
                div.innerHTML = `<div>${item.name}</div><div>${item.price} ₽</div>`;
                box.appendChild(div);
            });

        } catch (e) {
            box.innerHTML = '<div class="error">Не удалось связаться с таблицей. Проверьте ссылку API.</div>';
        }
    }

    async function send() {
        const dt = document.getElementById('dt').value;
        tg.showConfirm("Отправить?", async (ok) => {
            if(ok) {
                await fetch(API, {method:'POST', body:JSON.stringify({user, date:dt, items:{test:1}})});
                tg.showAlert("Готово!");
            }
        });
    }

    load(); tg.expand();
</script>
</body>
</html>
