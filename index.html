<!DOCTYPE html>
<html>
<head>
    <base target="_top">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        :root { --main: #007AFF; --bg: #F2F2F7; --card: #FFFFFF; --text: #000000; --hint: #8E8E93; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 0; overflow-x: hidden; }
        .tabs { display: flex; background: var(--card); position: sticky; top: 0; z-index: 100; padding: 10px; border-bottom: 0.5px solid #d1d1d6; }
        .tab { flex: 1; padding: 10px; text-align: center; font-weight: 600; font-size: 14px; color: var(--hint); transition: 0.2s; border-radius: 8px; cursor: pointer; }
        .tab.active { color: var(--main); background: rgba(0, 122, 255, 0.1); }
        .page { display: none; padding: 16px; padding-bottom: 120px; animation: fadeIn 0.3s ease; }
        .page.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .card { background: var(--card); border-radius: 12px; padding: 12px; margin-bottom: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
        .cat { font-size: 18px; font-weight: 700; margin: 10px 4px; color: var(--main); text-transform: uppercase; }
        .row { display: flex; align-items: center; justify-content: space-between; margin: 8px 0; }
        .counter { display: flex; align-items: center; gap: 12px; }
        .btn-c { width: 32px; height: 32px; border-radius: 50%; border: none; background: var(--bg); color: var(--main); font-size: 20px; font-weight: 700; display: flex; align-items: center; justify-content: center; cursor: pointer; }
        .btn-m { padding: 8px 16px; border-radius: 8px; border: none; font-weight: 600; cursor: pointer; font-size: 12px; }
        select, input { width: 100%; padding: 12px; border-radius: 10px; border: 1px solid #d1d1d6; font-size: 16px; background: var(--card); margin-bottom: 15px; }
        .shop-badge { background: var(--main); color: #fff; padding: 2px 6px; border-radius: 4px; font-size: 10px; }
    </style>
</head>
<body>
    <div class="tabs">
        <div class="tab active" onclick="showPage('order')">Заказ</div>
        <div class="tab" onclick="showPage('history')">История</div>
        <div id="tab-admin" class="tab" style="display:none;" onclick="showPage('admin')">Админ</div>
    </div>

    <div id="order" class="page active">
        <label>Дата:</label>
        <select id="dt-order" onchange="renderMenu()"></select>
        <div id="shop-selector"></div>
        <div id="menu-list"></div>
    </div>

    <div id="history" class="page">
        <div id="hist-list"></div>
    </div>

    <div id="admin" class="page">
        <label>Дата отчета:</label>
        <input type="date" id="dt-admin" onchange="renderAdmin()">
        <div id="admin-list"></div>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();
        const API = "https://script.google.com/macros/s/AKfycbzhxnl5umVfXrwdYVyly6EoZ8GSfpF_52X73D9AiNO1J3Ih-93FrJtaSSFk33CjfefY/exec"; // ВСТАВЬ СВОЙ URL ПОСЛЕ ДЕПЛОЯ
        const user = (tg.initDataUnsafe?.user?.username || "id_" + tg.initDataUnsafe?.user?.id || "guest").toLowerCase();
        let currentMenu = [], cart = {}, userOrders = {}, availableSheets = [], currentSheet = "";

        async function init() {
            const sel = document.getElementById('dt-order');
            for(let i=1; i<=7; i++) {
                const d = new Date(); d.setDate(d.getDate() + i);
                const iso = d.toISOString().split('T')[0];
                const label = d.toLocaleDateString('ru-RU', {day:'numeric', month:'short'});
                sel.add(new Option(label, iso));
            }
            document.getElementById('dt-admin').value = sel.value;
            await loadData();
            renderMenu();
        }

        async function loadData() {
            try {
                const res = await fetch(`${API}?user=${user}&type=init&sheet=${currentSheet}`).then(r => r.json());
                userOrders = res;
                if (res.isAdmin) document.getElementById('tab-admin').style.display = 'block';
            } catch(e) { console.error(e); }
        }

        async function renderMenu() {
            const list = document.getElementById('menu-list');
            const selDate = document.getElementById('dt-order').value;
            list.innerHTML = '<div style="text-align:center; padding:20px;">Загрузка меню...</div>';
            
            try {
                const res = await fetch(`${API}?type=menu&user=${user}&sheet=${currentSheet}`).then(r => r.json());
                currentMenu = res.menu;
                availableSheets = res.availableSheets || ["products"];
                currentSheet = res.currentSheet;
                
                renderShopSelector();

                const key = selDate + "_" + currentSheet;
                cart = userOrders[key] ? JSON.parse(JSON.stringify(userOrders[key].items)).reduce((a,v)=>{a[v.name]=v; return a;}, {}) : {};

                let html = "", lastCat = "";
                currentMenu.forEach(it => {
                    if(it.cat !== lastCat) { html += `<div class="cat">${it.cat}</div>`; lastCat = it.cat; }
                    const q = cart[it.name]?.qty || 0;
                    html += `<div class="card"><div class="row"><div><b>${it.name}</b><br><small>${it.price} ₽</small></div>
                        <div class="counter">
                            <button class="btn-c" onclick="changeQty('${it.name}', -1)">−</button>
                            <b id="q-${it.name}">${q}</b>
                            <button class="btn-c" onclick="changeQty('${it.name}', 1)">+</button>
                        </div></div></div>`;
                });
                list.innerHTML = html;
                updateMainButton();
            } catch(e) { list.innerHTML = "Ошибка загрузки"; }
        }

        function renderShopSelector() {
            const box = document.getElementById('shop-selector');
            if (availableSheets.length <= 1) { box.innerHTML = ""; return; }
            let html = '<div style="display:flex; gap:8px; margin-bottom:15px; overflow-x:auto; padding-bottom:5px;">';
            availableSheets.forEach(s => {
                const active = s === currentSheet;
                html += `<button class="btn-m" style="background:${active? 'var(--main)':'var(--card)'}; color:${active?'#fff':'#000'}; border:1px solid #ddd;" onclick="switchShop('${s}')">${s}</button>`;
            });
            box.innerHTML = html + '</div>';
        }

        function switchShop(s) { currentSheet = s; renderMenu(); }

        function changeQty(name, delta) {
            const it = currentMenu.find(m => m.name === name);
            if(!cart[name]) cart[name] = { name: name, qty: 0, price: it.price };
            cart[name].qty = Math.max(0, cart[name].qty + delta);
            if(cart[name].qty === 0) delete cart[name];
            document.getElementById(`q-${name}`).innerText = cart[name]?.qty || 0;
            updateMainButton();
        }

        function updateMainButton() {
            let total = 0, count = 0;
            for(let n in cart) { total += cart[n].qty * cart[n].price; count++; }
            if(count > 0) {
                const deliv = (total > 0 && total < 3000) ? 300 : 0;
                tg.MainButton.setText(`ОФОРМИТЬ: ${total + deliv} ₽`).show().onClick(sendOrder);
            } else tg.MainButton.hide();
        }

        async function sendOrder() {
            tg.MainButton.showProgress();
            const data = { user: user, date: document.getElementById('dt-order').value, items: cart, sheet: currentSheet };
            try {
                await fetch(API, { method: 'POST', body: JSON.stringify(data) });
                tg.showAlert("Заказ сохранен!");
                location.reload();
            } catch(e) { tg.showAlert("Ошибка!"); } finally { tg.MainButton.hideProgress(); }
        }

        function showPage(p) {
            document.querySelectorAll('.page, .tab').forEach(el => el.classList.remove('active'));
            document.getElementById(p).classList.add('active');
            event.currentTarget.classList.add('active');
            if(p === 'history') renderHistory();
            if(p === 'admin') renderAdmin();
        }

        function renderHistory() {
            const box = document.getElementById('hist-list');
            box.innerHTML = '<div class="cat">Мои заказы</div>';
            const sortedKeys = Object.keys(userOrders).sort().reverse();
            if(!sortedKeys.length) { box.innerHTML += '<div class="card">История пуста</div>'; return; }
            sortedKeys.forEach(k => {
                const o = userOrders[k];
                box.innerHTML += `<div class="card">
                    <div class="row"><div><b>${o.date.split('-').reverse().join('.')}</b> <span class="shop-badge">${o.sheet}</span></div><b>${o.total} ₽</b></div>
                    <button class="btn-m" style="background:#FF3B30; color:#fff;" onclick="deleteOrder('${o.date}', '${o.sheet}')">Удалить</button>
                </div>`;
            });
        }

        async function deleteOrder(date, sheet) {
            if(!confirm("Удалить заказ?")) return;
            try {
                await fetch(API, { method: 'POST', body: JSON.stringify({ user, date, sheet, deleteOrder: true }) });
                location.reload();
            } catch(e) { tg.showAlert("Ошибка"); }
        }

        async function renderAdmin() {
            const box = document.getElementById('admin-list'), sel = document.getElementById('dt-admin').value;
            box.innerHTML = '<div style="text-align:center; padding:20px;">Загрузка...</div>';
            try {
                const data = await fetch(`${API}?type=admin_all&date=${sel}&user=${user}`).then(r => r.json());
                box.innerHTML = `<div class="cat">Заказы на ${sel.split('-').reverse().join('.')}</div>`;
                if(!data.length) { box.innerHTML += '<div class="card">Заказов пока нет</div>'; return; }
                data.forEach(ord => {
                    box.innerHTML += `<div class="card"><div class="row"><div><b>${ord.displayName}</b> <span class="shop-badge">${ord.shop}</span><br><small>${ord.total} ₽</small></div></div></div>`;
                });
            } catch(e) { box.innerHTML = "Ошибка"; }
        }

        init();
    </script>
</body>
</html>
