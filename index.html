<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Moline Shop ü•ê</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root { --tg-theme-bg: #fff; --tg-theme-text: #000; --tg-theme-button: #e38e42; --tg-theme-button-text: #fff; }
        body { font-family: -apple-system, sans-serif; background: var(--tg-theme-bg); color: var(--tg-theme-text); margin: 0; padding: 0; user-select: none; }
        .tabs { display: flex; position: sticky; top: 0; background: var(--tg-theme-bg); z-index: 10; border-bottom: 1px solid #eee; }
        .tab { flex: 1; padding: 15px; text-align: center; cursor: pointer; opacity: 0.5; font-weight: bold; }
        .tab.active { opacity: 1; border-bottom: 3px solid var(--tg-theme-button); color: var(--tg-theme-button); }
        .content { padding: 15px; padding-bottom: 120px; }
        .item { display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid #f9f9f9; }
        .item-info { flex: 1; }
        .item-name { font-weight: 600; font-size: 15px; }
        .item-cat { font-size: 11px; color: #888; text-transform: uppercase; }
        .controls { display: flex; align-items: center; gap: 12px; }
        .btn { background: var(--tg-theme-button); color: var(--tg-theme-button-text); border: none; width: 32px; height: 32px; border-radius: 8px; font-size: 18px; font-weight: bold; }
        .footer { position: fixed; bottom: 0; width: 100%; padding: 20px; background: var(--tg-theme-bg); box-shadow: 0 -5px 15px rgba(0,0,0,0.05); box-sizing: border-box; }
        .main-btn { width: 100%; background: var(--tg-theme-button); color: var(--tg-theme-button-text); border: none; padding: 16px; border-radius: 12px; font-weight: bold; font-size: 16px; }
        .hidden { display: none; }
        .history-card { background: #fcfcfc; border: 1px solid #eee; border-radius: 12px; padding: 15px; margin-bottom: 15px; }
    </style>
</head>
<body>
    <div class="tabs">
        <div class="tab active" onclick="switchTab('order')">üõç –ó–∞–∫–∞–∑</div>
        <div class="tab" onclick="switchTab('history')">üìú –ò—Å—Ç–æ—Ä–∏—è</div>
    </div>

    <div id="order-page" class="content">
        <div id="menu-container">‚è≥ –ó–∞–≥—Ä—É–∂–∞–µ–º –≤–∫—É—Å–Ω—è—à–∫–∏...</div>
    </div>

    <div id="history-page" class="content hidden">
        <div id="history-container">–ò—Å—Ç–æ—Ä–∏—è –∑–∞–∫–∞–∑–æ–≤ –ø—É—Å—Ç–∞ üêå</div>
    </div>

    <div class="footer" id="footer">
        <button class="main-btn" onclick="sendOrder()">–û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑ ‚ú®</button>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        tg.expand();
        tg.ready();
        
        const API = 'https://script.google.com/macros/s/AKfycbzx9V8HKo7LeQlfoYSA4f-e89IxfUMU7p4PQ58htm5dejZifmQc3brNfW0Y9Pupsm6t/exec';
        const user = tg.initDataUnsafe?.user?.username || 'Guest';
        let cart = {};
        let menuData = [];

        async function loadData() {
            try {
                const res = await fetch(`${API}?type=menu`);
                const data = await res.json();
                menuData = data.menu;
                renderMenu();
                
                const hRes = await fetch(`${API}?type=history&user=${user}`);
                const history = await hRes.json();
                renderHistory(history);
            } catch(e) { 
                document.getElementById('menu-container').innerText = "–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ ‚ùå";
            }
        }

        function renderMenu() {
            const container = document.getElementById('menu-container');
            if (menuData.length === 0) { container.innerHTML = "–ú–µ–Ω—é –≤—Ä–µ–º–µ–Ω–Ω–æ –ø—É—Å—Ç–æ ü•£"; return; }
            
            container.innerHTML = menuData.map(item => `
                <div class="item">
                    <div class="item-info">
                        <div class="item-cat">${item.cat}</div>
                        <div class="item-name">${item.name}</div>
                        <div style="font-weight: bold; margin-top: 4px;">${item.price} ‚ÇΩ</div>
                    </div>
                    <div class="controls">
                        <button class="btn" onclick="updateCart('${item.name}', -1, ${item.price})">‚àí</button>
                        <span id="q-${item.name}" style="min-width: 20px; text-align: center; font-weight: bold;">${cart[item.name]?.qty || 0}</span>
                        <button class="btn" onclick="updateCart('${item.name}', 1, ${item.price})">+</button>
                    </div>
                </div>
            `).join('');
        }

        function updateCart(name, delta, price) {
            if (!cart[name]) cart[name] = { qty: 0, price: price };
            cart[name].qty = Math.max(0, cart[name].qty + delta);
            if (cart[name].qty === 0) delete cart[name];
            document.getElementById(`q-${name}`).innerText = cart[name]?.qty || 0;
            tg.HapticFeedback.impactOccurred('light');
        }

        async function sendOrder() {
            if (Object.keys(cart).length === 0) { alert('–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ —á—Ç–æ-–Ω–∏–±—É–¥—å –≤–∫—É—Å–Ω–æ–µ! ü•ê'); return; }
            
            const tomorrow = new Date(); tomorrow.setDate(tomorrow.getDate() + 1);
            const defaultDate = tomorrow.toISOString().split('T')[0];
            const date = prompt("–ù–∞ –∫–∞–∫—É—é –¥–∞—Ç—É –∑–∞–∫–∞–∑? (–ì–ì–ì–ì-–ú–ú-–î–î)", defaultDate);
            
            if (!date) return;

            tg.MainButton.setText("–û–¢–ü–†–ê–í–õ–Ø–ï–ú...");
            tg.MainButton.show();
            
            try {
                const response = await fetch(API, {
                    method: 'POST',
                    mode: 'no-cors',
                    body: JSON.stringify({ user, date, items: cart })
                });
                alert('–ó–∞–∫–∞–∑ —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω! üöÄ');
                tg.close();
            } catch(e) { 
                alert('–ó–∞–∫–∞–∑ –∑–∞–ø–∏—Å–∞–Ω! (–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –≥—Ä—É–ø–ø—É)'); 
                tg.close();
            }
        }

        function switchTab(tab) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            const activeTab = Array.from(document.querySelectorAll('.tab')).find(t => t.innerText.includes(tab === 'order' ? '–ó–∞–∫–∞–∑' : '–ò—Å—Ç–æ—Ä–∏—è'));
            if(activeTab) activeTab.classList.add('active');
            
            document.getElementById('order-page').classList.toggle('hidden', tab !== 'order');
            document.getElementById('history-page').classList.toggle('hidden', tab !== 'history');
            document.getElementById('footer').classList.toggle('hidden', tab !== 'order');
        }

        function renderHistory(history) {
            const container = document.getElementById('history-container');
            const dates = Object.keys(history).sort().reverse();
            if (dates.length === 0) return;
            container.innerHTML = dates.map(date => `
                <div class="history-card">
                    <div style="color: var(--tg-theme-button); font-weight: bold; margin-bottom: 8px;">üìÖ ${date}</div>
                    ${history[date].items.map(i => `‚Ä¢ ${i.name} x${i.qty}`).join('<br>')}
                    <div style="margin-top: 10px; border-top: 1px dashed #ccc; pt: 5px; font-weight: bold;">–ò—Ç–æ–≥–æ: ${history[date].total} ‚ÇΩ</div>
                </div>
            `).join('');
        }

        loadData();
    </script>
</body>
</html>
