<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body { font-family: sans-serif; background: #f4f6f9; margin: 0; padding: 15px; }
        .card { background: #fff; border-radius: 12px; padding: 15px; margin-bottom: 10px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .row { display: flex; justify-content: space-between; align-items: center; }
        .price { color: #0088cc; font-weight: bold; }
        .stepper { display: flex; align-items: center; background: #eee; border-radius: 15px; padding: 2px 10px; }
        .btn-s { background: none; border: none; font-size: 20px; color: #0088cc; padding: 5px 10px; }
        .footer { position: fixed; bottom: 0; left: 0; width: 100%; background: #fff; padding: 15px; border-top: 1px solid #ddd; display: flex; justify-content: space-between; box-sizing: border-box; }
        .btn-main { background: #0088cc; color: #fff; border: none; padding: 10px 20px; border-radius: 10px; font-weight: bold; }
        .hidden { display: none; }
    </style>
</head>
<body>
    <div id="order-page">
        <input type="date" id="date-in" style="width:100%; padding:10px; margin-bottom:15px; border:1px solid #ddd; border-radius:8px;">
        <div id="menu-container">Загрузка меню...</div>
    </div>

    <div class="footer">
        <div>Итого:<br><b id="total-view">0 ₽</b></div>
        <button class="btn-main" onclick="sendOrder()">ОФОРМИТЬ</button>
    </div>

<script>
    const tg = window.Telegram.WebApp;
    const API = 'ВАША_НОВАЯ_ССЫЛКА_EXEC'; // ОБЯЗАТЕЛЬНО ОБНОВИТЕ
    const user = (tg.initDataUnsafe.user?.username || tg.initDataUnsafe.user?.id || "guest").toLowerCase();

    let menu = [];
    let cart = {};

    async function load() {
        // Установка завтрашней даты
        let tomorrow = new Date(); tomorrow.setDate(tomorrow.getDate() + 1);
        document.getElementById('date-in').value = tomorrow.toISOString().split('T')[0];

        try {
            const r = await fetch(`${API}?type=menu&user=${user}&v=${Date.now()}`);
            const data = await r.json();
            if (data.error) throw data.error;
            menu = data.menu;
            render();
        } catch(e) {
            document.getElementById('menu-container').innerHTML = `<center style="color:red">Ошибка: ${e}</center>`;
        }
    }

    function render() {
        const box = document.getElementById('menu-container');
        box.innerHTML = '';
        menu.forEach(item => {
            const q = cart[item.name] || 0;
            const div = document.createElement('div');
            div.className = 'card row';
            div.innerHTML = `
                <div><b>${item.name}</b><br><span class="price">${item.price} ₽</span></div>
                <div class="stepper">
                    <button class="btn-s" onclick="change('${item.name}', -1)">−</button>
                    <span style="margin: 0 10px">${q}</span>
                    <button class="btn-s" onclick="change('${item.name}', 1)">+</button>
                </div>`;
            box.appendChild(div);
        });
        updateTotal();
    }

    function change(name, delta) {
        cart[name] = (cart[name] || 0) + delta;
        if (cart[name] <= 0) delete cart[name];
        render();
    }

    function updateTotal() {
        let sum = 0;
        menu.forEach(i => { if(cart[i.name]) sum += cart[i.name] * i.price; });
        // Защита от NaN: если sum не число, ставим 0
        document.getElementById('total-view').innerText = (isNaN(sum) ? 0 : sum) + " ₽";
    }

    async function sendOrder() {
        const date = document.getElementById('date-in').value;
        const items = {};
        menu.forEach(i => { if(cart[i.name]) items[i.name] = {qty: cart[i.name], price: i.price}; });
        
        if (Object.keys(items).length === 0) return tg.showAlert("Выберите товары!");

        tg.showConfirm(`Заказать на ${date}?`, async (ok) => {
            if (ok) {
                await fetch(API, {method: 'POST', body: JSON.stringify({user, date, items})});
                tg.showAlert("Заказ отправлен!");
                cart = {};
                render();
            }
        });
    }

    load(); tg.expand();
</script>
</body>
</html>
